name: Performance

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  performance:
    name: Performance Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests with performance metrics
        run: |
          yarn test:ci --verbose > test-output.txt 2>&1
          echo "## Test Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "### Test Execution Time" >> $GITHUB_STEP_SUMMARY
          grep -o "Tests:.*passed.*[0-9]*\.[0-9]* s" test-output.txt >> $GITHUB_STEP_SUMMARY || echo "No timing data found" >> $GITHUB_STEP_SUMMARY

      - name: Bundle size analysis
        run: |
          echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Dependencies Size" >> $GITHUB_STEP_SUMMARY
          du -sh node_modules/ | awk '{print "`" $1 "`"}' >> $GITHUB_STEP_SUMMARY
          echo "### Source Code Size" >> $GITHUB_STEP_SUMMARY
          find src/ -name "*.ts" | xargs wc -l | tail -1 >> $GITHUB_STEP_SUMMARY

      - name: Type checking performance
        run: |
          echo "## TypeScript Performance" >> $GITHUB_STEP_SUMMARY
          echo "### Type Checking Time" >> $GITHUB_STEP_SUMMARY
          time yarn type-check >> $GITHUB_STEP_SUMMARY 2>&1 || true

      - name: Linting performance
        run: |
          echo "## Linting Performance" >> $GITHUB_STEP_SUMMARY
          echo "### Linting Time" >> $GITHUB_STEP_SUMMARY
          time yarn lint >> $GITHUB_STEP_SUMMARY 2>&1 || true
